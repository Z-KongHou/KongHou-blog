---
title: ä»æ‰§è¡Œä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸé“¾è§’åº¦å½»åº•ç†è§£ JavaScript é—­åŒ…
date: 2025-10-23 12:47:37
tags: [JavaScript, å‰ç«¯]
category: å‰ç«¯
---

# ä»æ‰§è¡Œä¸Šä¸‹æ–‡å’Œä½œç”¨åŸŸé“¾è§’åº¦å½»åº•ç†è§£ JavaScript é—­åŒ…

> â€œé—­åŒ…ä¸æ˜¯è¯­æ³•ç‰¹æ€§ï¼Œè€Œæ˜¯æ‰§è¡Œæœºåˆ¶çš„è‡ªç„¶ç»“æœã€‚â€
> â€” ECMAScript è§„èŒƒè§£è¯»

---

(ps: ç”±äºç¬”è€…åœ¨å­¦ä¹ ç›¸å…³å†…å®¹æ—¶å°šæœªæ˜ç¡® ES6 ä»¥å VE æ˜¯å¦å·²ç»è¢«ç§»é™¤ï¼Œå› æ­¤åœ¨æœ¬æ–‡ä¸­æš‚æ—¶åªä»¥ LE æ¥æŒ‡ä»£è¯æ³•ç¯å¢ƒ)

## ä¸€ã€å‰è¨€

åœ¨ JavaScript å­¦ä¹ ä¸­ï¼Œâ€œé—­åŒ…ï¼ˆClosureï¼‰â€æ˜¯ä¸€ä¸ªæ—¢ç†Ÿæ‚‰åˆæŠ½è±¡çš„æ¦‚å¿µã€‚
æˆ‘ä»¬å¸¸å¬åˆ°å®ƒçš„å®šä¹‰ï¼š

> **é—­åŒ…æ˜¯å‡½æ•°ä¸å…¶è¯æ³•ä½œç”¨åŸŸçš„ç»„åˆã€‚**

ä½†å¦‚æœä¸äº†è§£â€œæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰â€å’Œâ€œè¯æ³•ç¯å¢ƒï¼ˆLexical Environmentï¼‰â€ï¼Œ
è¿™å¥è¯ä¾ç„¶è®©äººä¸€å¤´é›¾æ°´ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬ä» **å¼•æ“çš„æ‰§è¡Œæœºåˆ¶** å‡ºå‘ï¼Œ
ç”¨ **æ‰§è¡Œä¸Šä¸‹æ–‡ + ä½œç”¨åŸŸé“¾ï¼ˆLE é“¾ï¼‰** çš„æ–¹å¼ï¼Œå®Œæ•´æ‹†è§£é—­åŒ…çš„æœ¬è´¨ã€‚

---

## äºŒã€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰

å½“ JavaScript ä»£ç è¿è¡Œæ—¶ï¼Œæ¯ä¸€æ®µå¯æ‰§è¡Œçš„ä»£ç ï¼ˆå…¨å±€ã€å‡½æ•°ã€æ¨¡å—ç­‰ï¼‰
éƒ½ä¼šå¯¹åº”ä¸€ä¸ªâ€œæ‰§è¡Œä¸Šä¸‹æ–‡â€ï¼ˆç®€ç§° ECï¼‰ã€‚

æ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

| åç§°                          | å«ä¹‰                             |
| ----------------------------- | -------------------------------- |
| **Lexical Environmentï¼ˆLEï¼‰** | è®°å½•å½“å‰ä½œç”¨åŸŸä¸­å®šä¹‰çš„å˜é‡å’Œå‡½æ•° |
| **thisBinding**               | å½“å‰ä¸Šä¸‹æ–‡çš„ this å€¼             |

---

## ä¸‰ã€è¯æ³•ç¯å¢ƒï¼ˆLexical Environmentï¼‰

**è¯æ³•ç¯å¢ƒ** æ˜¯ä¸€ä¸ªå†…éƒ¨ç»“æ„ï¼ŒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

```js
LexicalEnvironment = {
  EnvironmentRecord: { å˜é‡å â†’ å€¼ },
  Outer: æŒ‡å‘å¤–å±‚çš„ LE
}
```

ğŸ‘‰ **EnvironmentRecord** å­˜æ”¾äº†æœ¬ä½œç”¨åŸŸå†…çš„æ‰€æœ‰å˜é‡ã€å‡½æ•°å£°æ˜ã€å‚æ•°ç­‰ã€‚
ğŸ‘‰ **Outer** æŒ‡é’ˆåˆ™å½¢æˆäº†ä¸€æ¡ **ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰**ã€‚

---

## å››ã€ç”¨ä¾‹å­ç†è§£é—­åŒ…å½¢æˆè¿‡ç¨‹

æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç»å…¸çš„ä¾‹å­å‡ºå‘ ğŸ‘‡

```js
function outer() {
  var count = 0;
  function inner() {
    count++;
    console.log(count);
  }
  return inner;
}

const fn = outer();
fn(); // 1
fn(); // 2
```

---

## äº”ã€é—­åŒ…å½¢æˆçš„å…¨è¿‡ç¨‹ï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡è§†è§’ï¼‰

### ğŸ§© Step 1ï¼šåˆ›å»ºå…¨å±€ä¸Šä¸‹æ–‡

å…¨å±€ä»£ç å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå¼•æ“åˆ›å»º `EC_Global`ï¼š

```
EC_Global:
  LE_Global:
    outer -> <function outer>
    fn -> TDZ (ç¨åèµ‹å€¼)
    Outer -> null
```

---

### ğŸ§© Step 2ï¼šæ‰§è¡Œ `outer()` åˆ›å»ºå‡½æ•°ä¸Šä¸‹æ–‡

è°ƒç”¨ `outer()` æ—¶ï¼Œå¼•æ“åˆ›å»ºæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ `EC_outer`ï¼š

```
EC_outer:
  LE_outer:
    count -> undefined
    inner -> <function inner>
    Outer -> LE_Global
```

âš™ï¸ è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®åŠ¨ä½œï¼š
å½“è§£æ `function inner() {}` æ—¶ï¼Œå¼•æ“ä¼š **åˆ›å»ºå‡½æ•°å¯¹è±¡ `inner`ï¼Œå¹¶ç«‹å³ç»‘å®šç¯å¢ƒå¼•ç”¨**ï¼š

```
inner.[[Environment]] = LE_outer âœ…
```

---

### ğŸ§© Step 3ï¼šè¿”å› `inner` å¹¶é”€æ¯ `outer` çš„æ‰§è¡Œä¸Šä¸‹æ–‡

å½“ `outer()` æ‰§è¡Œå®Œæ¯•åï¼Œå®ƒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆEC_outerï¼‰å‡ºæ ˆã€‚
ä½†ç”±äº `inner.[[Environment]]` ä»ç„¶æŒæœ‰å¯¹ `LE_outer` çš„å¼•ç”¨ï¼Œ
æ‰€ä»¥ `LE_outer` **ä¸ä¼šè¢«åƒåœ¾å›æ”¶**ã€‚

è¿™å°±æ˜¯é—­åŒ…å­˜åœ¨çš„æ ¹æœ¬åŸå› ã€‚

```
fn = inner
inner.[[Environment]] -> LE_outer
```

---

### ğŸ§© Step 4ï¼šæ‰§è¡Œ `fn()`ï¼ˆå³ innerï¼‰

è°ƒç”¨ `fn()` æ—¶ï¼š

```
EC_inner:
  LE_inner:
    Outer -> LE_outer
```

æ‰§è¡Œ `console.log(count)` æ—¶ï¼š

- å¼•æ“å…ˆåœ¨å½“å‰ `LE_inner` æŸ¥æ‰¾ `count`
- æ‰¾ä¸åˆ°ï¼Œæ²¿ `Outer` æ‰¾åˆ° `LE_outer`
- ä¿®æ”¹äº† `LE_outer` ä¸­çš„ `count` å€¼

äºæ˜¯æ¯æ¬¡æ‰§è¡Œ `fn()` æ—¶ï¼Œ`count` éƒ½èƒ½ä¿æŒä¸Šä¸€æ¬¡çš„çŠ¶æ€ã€‚

---

## å…­ã€ç”¨å›¾è¡¨ç¤ºé—­åŒ…ç»“æ„ï¼ˆES6 ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC_Global                    â”‚
â”‚  LE_Global:                  â”‚
â”‚    outer â†’ <function outer>  â”‚
â”‚    fn â†’ TDZ / <function>     â”‚
â”‚    Outer â†’ null              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è°ƒç”¨ outer()
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC_outer                     â”‚
â”‚  LE_outer:                   â”‚
â”‚    count â†’ 0                 â”‚
â”‚    inner â†’ <function inner>  â”‚
â”‚    Outer â†’ LE_Global         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ inner.[[Environment]] = LE_outer
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC_inner (fn è°ƒç”¨æ—¶åˆ›å»º)     â”‚
â”‚  LE_inner:                   â”‚
â”‚    Outer â†’ LE_outer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€é—­åŒ…çš„æœ¬è´¨

> **é—­åŒ…æ˜¯å‡½æ•°ä¸å…¶å®šä¹‰æ—¶çš„è¯æ³•ç¯å¢ƒçš„ç»„åˆã€‚**

å®ƒèƒ½â€œè®°ä½â€å¤–éƒ¨å‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼Œ
å³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä½œç”¨åŸŸé“¾ä¾ç„¶è¢«ä¿ç•™ã€‚

æ¢å¥è¯è¯´ï¼š

> å‡½æ•°åˆ›å»ºæ—¶çš„ `[[Environment]]` æŒ‡é’ˆï¼Œ
> æ˜¯é—­åŒ…å­˜åœ¨çš„æ ¹æœ¬æœºåˆ¶ã€‚

---

## å…«ã€æ€»ç»“

| æ¦‚å¿µ                 | å«ä¹‰                  | ç¤ºä¾‹                               |
| -------------------- | --------------------- | ---------------------------------- |
| **æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆECï¼‰** | JS ä»£ç æ‰§è¡Œçš„è¿è¡Œå®¹å™¨ | Globalã€å‡½æ•°è°ƒç”¨                   |
| **è¯æ³•ç¯å¢ƒï¼ˆLEï¼‰**   | å­˜å‚¨å˜é‡ä¸å¤–éƒ¨å¼•ç”¨    | `{ EnvironmentRecord, Outer }`     |
| **é—­åŒ…ï¼ˆClosureï¼‰**  | å‡½æ•° + å®šä¹‰æ—¶çš„ LE    | `inner.[[Environment]] = LE_outer` |

è¿™é‡Œç”¨ä¸€å‰¯å›¾æ¥å¤§è‡´æ¦‚å†µæœ¬æ–‡å†…å®¹ï¼š
<img src='012.png' alt='é—­åŒ…ç»“æ„å›¾' height='400px'/>
